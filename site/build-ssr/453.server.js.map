{"version":3,"file":"453.server.js","mappings":"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","sources":["webpack://personal-site/./src/utils/media-providers/image-upgrade-manager.ts","webpack://personal-site/./src/utils/media-providers/media-loader.tsx","webpack://personal-site/./src/utils/media-providers/video-observer.tsx","webpack://personal-site/./src/components/block-type-1/ice-cream-scoop.tsx"],"sourcesContent":["// src/utils/image-upgrade-manager.ts\r\nlet totalImages = 0;\r\nlet loadedLowRes = 0;\r\nlet listeners: (() => void)[] = [];\r\nlet upgradeTimeout: ReturnType<typeof setTimeout> | null = null;\r\n\r\nexport const setUpgradeTimeout = (ms: number = 5000) => {\r\n  if (upgradeTimeout) return;\r\n  upgradeTimeout = setTimeout(() => {\r\n    listeners.forEach(fn => fn());\r\n    listeners = [];\r\n  }, ms);\r\n};\r\n\r\nexport const registerImage = () => {\r\n  totalImages++;\r\n  setUpgradeTimeout();\r\n};\r\n\r\nexport const notifyLowResLoaded = () => {\r\n  loadedLowRes++;\r\n  if (loadedLowRes >= totalImages) {\r\n    listeners.forEach(fn => fn());\r\n    listeners = [];\r\n  }\r\n};\r\n\r\nexport const onAllLowResLoaded = (callback: () => void) => {\r\n  listeners.push(callback);\r\n};\r\n","// src/utils/media-providers/media-loader.tsx\r\nimport { useRef, useState, useEffect } from 'react';\r\nimport { useVideoVisibility } from './video-observer';\r\nimport LoadingScreen from '../loading/loading';\r\nimport { SanityImageSource } from '@sanity/image-url/lib/types/types';\r\nimport {\r\n  getLowResImageUrl,\r\n  getMediumImageUrl,\r\n  getHighQualityImageUrl,\r\n  urlFor,\r\n} from './image-builder';\r\nimport {\r\n  registerImage,\r\n  notifyLowResLoaded,\r\n  onAllLowResLoaded,\r\n} from './image-upgrade-manager';\r\n\r\nfunction useNearViewport<T extends Element>(\r\n  ref: React.RefObject<T>,\r\n  { rootMargin = '900px 0px', threshold = 0, once = true } = {}\r\n) {\r\n  const [near, setNear] = useState(false);\r\n  useEffect(() => {\r\n    if (!ref.current || near) return;\r\n    const io = new IntersectionObserver(\r\n      (entries) => {\r\n        if (entries.some((e) => e.isIntersecting)) {\r\n          setNear(true);\r\n          if (once) io.disconnect();\r\n        }\r\n      },\r\n      { rootMargin, threshold }\r\n    );\r\n    io.observe(ref.current);\r\n    return () => io.disconnect();\r\n  }, [ref, near, rootMargin, threshold, once]);\r\n  return near;\r\n}\r\n\r\ntype VideoSetSrc = {\r\n  webmUrl?: string;\r\n  mp4Url?: string;\r\n  poster?: SanityImageSource | string;\r\n};\r\n\r\ntype MediaLoaderProps = {\r\n  type: 'image' | 'video';\r\n  src: string | SanityImageSource | VideoSetSrc | null | undefined;\r\n  alt?: string;\r\n  id?: string;\r\n  className?: string;\r\n  style?: React.CSSProperties;\r\n  objectPosition?: string;\r\n  loop?: boolean;\r\n  muted?: boolean;\r\n  playsInline?: boolean;\r\n  preload?: 'auto' | 'metadata' | 'none';\r\n  enableVisibilityControl?: boolean;\r\n  priority?: boolean;\r\n  controls?: boolean;\r\n};\r\n\r\nconst MediaLoader = ({\r\n  type,\r\n  src,\r\n  alt = '',\r\n  id,\r\n  className = '',\r\n  style = {},\r\n  objectPosition = 'center center',\r\n  loop = true,\r\n  muted = true,\r\n  playsInline = true,\r\n  preload = 'metadata',\r\n  enableVisibilityControl = true,\r\n  priority = false,\r\n  controls = false,\r\n}: MediaLoaderProps) => {\r\n  const isSSR = typeof window === 'undefined';\r\n\r\n  // Start as loaded in SSR to avoid fade-in on hydration\r\n  const [loaded, setLoaded] = useState(isSSR);\r\n  const [showMedium, setShowMedium] = useState(false);\r\n  const [showHigh, setShowHigh] = useState(false);\r\n\r\n  // Native poster control (no overlay)\r\n  const [posterRemoved, setPosterRemoved] = useState(false);\r\n\r\n  const videoRef = useRef<HTMLVideoElement>(null);\r\n  const imgRef = useRef<HTMLImageElement>(null);\r\n  const containerRef = useRef<HTMLDivElement>(null);\r\n\r\n  const isNear = useNearViewport(containerRef);\r\n  const shouldStart = priority || isNear;\r\n\r\n  // If already cached, skip fade-in\r\n  useEffect(() => {\r\n    if (type === 'image' && imgRef.current?.complete) setLoaded(true);\r\n    if (type === 'video' && videoRef.current?.readyState >= 2) setLoaded(true);\r\n  }, [type]);\r\n\r\n  // IMAGE progressive upgrade\r\n  useEffect(() => {\r\n    if (type !== 'image') return;\r\n    registerImage();\r\n\r\n    const t1 = setTimeout(() => setShowMedium(true), shouldStart ? 0 : 2000);\r\n    if (shouldStart) setShowMedium(true);\r\n\r\n    const off = () => setTimeout(() => setShowHigh(true), 300);\r\n    onAllLowResLoaded(off);\r\n    const t2 = setTimeout(() => setShowHigh(true), 5000);\r\n\r\n    return () => {\r\n      clearTimeout(t1);\r\n      clearTimeout(t2);\r\n    };\r\n  }, [type, shouldStart]);\r\n\r\n  const onMediaLoaded = () => {\r\n    setLoaded(true);\r\n    if (type === 'image') notifyLowResLoaded();\r\n    if (id) {\r\n      const event = new CustomEvent('mediaReady', { detail: { id } });\r\n      window.dispatchEvent(event);\r\n    }\r\n  };\r\n\r\n  // ----- Video source parsing + poster URL -----\r\n  const isVideoSetObj =\r\n    typeof src === 'object' &&\r\n    src !== null &&\r\n    !('asset' in (src as any)) &&\r\n    (('webmUrl' in (src as any)) || ('mp4Url' in (src as any)));\r\n\r\n  const vs = (isVideoSetObj ? (src as VideoSetSrc) : undefined);\r\n  const legacyVideoUrl = typeof src === 'string' ? src : undefined;\r\n\r\n  const posterUrl =\r\n    vs?.poster\r\n      ? (typeof vs.poster === 'string'\r\n          ? vs.poster\r\n          : urlFor(vs.poster).width(1200).quality(80).auto('format').url())\r\n      : undefined;\r\n\r\n  // ✅ Keep native poster visible until the first *painted* frame, then remove it.\r\n  useEffect(() => {\r\n    if (type !== 'video' || !videoRef.current) return;\r\n    const v = videoRef.current;\r\n\r\n    const hidePoster = () => {\r\n      setPosterRemoved(true);\r\n      v.removeAttribute('poster');\r\n    };\r\n\r\n    const onPlay = () => {\r\n      const anyV = v as any;\r\n      if (typeof anyV.requestVideoFrameCallback === 'function') {\r\n        anyV.requestVideoFrameCallback(() => hidePoster());\r\n      } else {\r\n        const onTime = () => {\r\n          if (v.currentTime > 0 && v.readyState >= 2) {\r\n            v.removeEventListener('timeupdate', onTime);\r\n            hidePoster();\r\n          }\r\n        };\r\n        v.addEventListener('timeupdate', onTime);\r\n        const timer = setTimeout(() => {\r\n          v.removeEventListener('timeupdate', onTime);\r\n          hidePoster();\r\n        }, 1200);\r\n        return () => clearTimeout(timer);\r\n      }\r\n    };\r\n\r\n    v.addEventListener('play', onPlay, { once: true });\r\n    return () => v.removeEventListener('play', onPlay);\r\n  }, [type]);\r\n\r\n  // VIDEO visibility/autoplay (your existing hook takes care of play/pause)\r\n  useVideoVisibility(\r\n    videoRef,\r\n    containerRef,\r\n    type === 'video' && enableVisibilityControl ? 0.35 : (undefined as unknown as number)\r\n  );\r\n\r\n  // ─────────────────────────────────────────────────────────────\r\n  // VIDEO RELIABILITY PATCHES\r\n  // - Kick load when near\r\n  // - Retry once, then promote preload to 'auto'\r\n  // - Decode nudge for iOS Safari after loadedmetadata\r\n  // - Early \"loaded\" on loadedmetadata to remove spinner sooner\r\n  // - Gentle play kick when data is ready (muted+inline)\r\n  // ─────────────────────────────────────────────────────────────\r\n  useEffect(() => {\r\n    if (type !== 'video' || !videoRef.current) return;\r\n    const v = videoRef.current;\r\n\r\n    let retryTimer: number | null = null;\r\n    let promoteTimer: number | null = null;\r\n\r\n    const clearTimers = () => {\r\n      if (retryTimer) { window.clearTimeout(retryTimer); retryTimer = null; }\r\n      if (promoteTimer) { window.clearTimeout(promoteTimer); promoteTimer = null; }\r\n    };\r\n\r\n    // If we’re near (or priority), ensure the browser actually fetches metadata\r\n    const kickLoad = () => {\r\n      try {\r\n        // set the DOM property; the attribute React renders can be different and that's OK\r\n        v.preload = preload ?? 'metadata';\r\n        if (v.preload !== 'none') v.load(); // important: actually trigger the fetch\r\n      } catch {}\r\n    };\r\n\r\n    const nudgeDecode = () => {\r\n      // iOS Safari sometimes stalls after metadata; a tiny seek wakes decode\r\n      try {\r\n        if (v.readyState < 2) return;\r\n        const t = v.currentTime;\r\n        v.currentTime = t > 0 ? t : 0.001;\r\n      } catch {}\r\n    };\r\n\r\n    const tryPlay = async () => {\r\n      if (!enableVisibilityControl) return;\r\n      try {\r\n        if (v.muted && v.playsInline && v.paused && v.readyState >= 2) {\r\n          await v.play().catch(() => {});\r\n        }\r\n      } catch {}\r\n    };\r\n\r\n    const onLoadedMeta = () => {\r\n      // spinner can go away on metadata (poster is still covering until first frame)\r\n      setLoaded(true);\r\n      nudgeDecode();\r\n    };\r\n\r\n    const onLoadedData = () => { setLoaded(true); void tryPlay(); };\r\n    const onCanPlay = () => { setLoaded(true); void tryPlay(); };\r\n\r\n    if (shouldStart) {\r\n      kickLoad();\r\n\r\n      // If nothing after ~2.5s, try load() once more\r\n      retryTimer = window.setTimeout(() => {\r\n        if (v.readyState < 2) kickLoad();\r\n      }, 2500);\r\n\r\n      // Still nothing after ~5s? Promote preload to 'auto'\r\n      promoteTimer = window.setTimeout(() => {\r\n        if (v.readyState < 2) {\r\n          try { v.preload = 'auto'; v.load(); } catch {}\r\n        }\r\n      }, 5000);\r\n    }\r\n\r\n    v.addEventListener('loadedmetadata', onLoadedMeta);\r\n    v.addEventListener('loadeddata', onLoadedData);\r\n    v.addEventListener('canplay', onCanPlay);\r\n\r\n    // Optional: diagnostics for flaky networks\r\n    const onError = (e: Event) => console.warn('Video error', e);\r\n    const onStalled = () => console.warn('Video stalled');\r\n    const onSuspend = () => {/* benign on many browsers */};\r\n    v.addEventListener('error', onError);\r\n    v.addEventListener('stalled', onStalled);\r\n    v.addEventListener('suspend', onSuspend);\r\n\r\n    return () => {\r\n      clearTimers();\r\n      v.removeEventListener('loadedmetadata', onLoadedMeta);\r\n      v.removeEventListener('loadeddata', onLoadedData);\r\n      v.removeEventListener('canplay', onCanPlay);\r\n      v.removeEventListener('error', onError);\r\n      v.removeEventListener('stalled', onStalled);\r\n      v.removeEventListener('suspend', onSuspend);\r\n    };\r\n  }, [\r\n    type,\r\n    shouldStart,\r\n    preload,\r\n    enableVisibilityControl,\r\n    // if any URL changes, re-run the loader watchdog\r\n    isVideoSetObj,\r\n    (vs && vs.webmUrl) || '',\r\n    (vs && vs.mp4Url) || '',\r\n    legacyVideoUrl || '',\r\n  ]);\r\n\r\n  const hasVideoSource = Boolean(vs?.webmUrl || vs?.mp4Url || legacyVideoUrl);\r\n  if (!src || (type === 'video' && !hasVideoSource)) return null;\r\n\r\n  // ====== IMAGE ======\r\n  if (type === 'image') {\r\n    const ultraLowSrc = typeof src === 'string' ? src : getLowResImageUrl(src);\r\n    const mediumSrc   = typeof src === 'string' ? src : getMediumImageUrl(src);\r\n    const highResSrc  = typeof src === 'string' ? src : getHighQualityImageUrl(src);\r\n\r\n    const resolvedSrc = showHigh ? highResSrc : showMedium ? mediumSrc : ultraLowSrc;\r\n    if (!resolvedSrc) return null;\r\n\r\n    return (\r\n      <div ref={containerRef} style={{ position: 'relative', width: '100%', height: '100%' }}>\r\n        {!loaded && (\r\n          <div className=\"absolute-inset\">\r\n            <LoadingScreen isFullScreen={false} />\r\n          </div>\r\n        )}\r\n        <img\r\n          ref={imgRef}\r\n          loading={priority ? 'eager' : undefined}\r\n          fetchPriority={showHigh || priority ? 'high' : showMedium ? 'auto' : 'low'}\r\n          id={id}\r\n          src={resolvedSrc || undefined}\r\n          alt={alt}\r\n          onLoad={onMediaLoaded}\r\n          onError={(e) => console.warn('Image failed', (e.target as HTMLImageElement).src)}\r\n          className={className}\r\n          draggable={false}\r\n          style={{\r\n            ...style,\r\n            objectFit: 'cover',\r\n            objectPosition,\r\n            opacity: loaded ? 1 : 0,\r\n            transition: isSSR ? 'none' : 'filter 0.5s ease, opacity 0.3s ease',\r\n          }}\r\n        />\r\n      </div>\r\n    );\r\n  }\r\n\r\n  // ====== VIDEO ======\r\n  const showSpinner = !loaded;\r\n\r\n  return (\r\n    <div ref={containerRef} style={{ position: 'relative', width: '100%', height: '100%' }}>\r\n      {showSpinner && (\r\n        <div className=\"absolute-inset\">\r\n          <LoadingScreen isFullScreen={false} />\r\n        </div>\r\n      )}\r\n\r\n      <video\r\n        id={id}\r\n        ref={videoRef}\r\n        // treat loadeddata & metadata as “ready enough” for UI\r\n        onLoadedData={onMediaLoaded}\r\n        onLoadedMetadata={() => setLoaded(true)}\r\n        onError={(e) => console.warn('Video failed', e)}\r\n        className={className}\r\n        style={{\r\n          ...style,\r\n          objectFit: 'cover',\r\n          objectPosition,\r\n          opacity: loaded ? 1 : 0,\r\n          transition: isSSR ? 'none' : 'opacity 0.3s ease',\r\n          pointerEvents: 'all',\r\n          zIndex: 1,\r\n        }}\r\n        loop={loop}\r\n        muted={muted}\r\n        playsInline={playsInline}\r\n        preload={preload ?? 'metadata'}\r\n        controls={controls}\r\n        // If you host poster/video on different origins and ever read pixels to <canvas>,\r\n        // uncomment next line and ensure CORS headers exist:\r\n        // crossOrigin=\"anonymous\"\r\n        poster={posterRemoved ? undefined : posterUrl}\r\n      >\r\n        {/* Order matters: prefer MP4 first for Safari reliability */}\r\n        {vs?.mp4Url  && <source src={vs.mp4Url  || undefined} type=\"video/mp4\"  />}\r\n        {vs?.webmUrl && <source src={vs.webmUrl || undefined} type=\"video/webm\" />}\r\n        {!vs?.webmUrl && !vs?.mp4Url && legacyVideoUrl && (\r\n          <source src={legacyVideoUrl || undefined} />\r\n        )}\r\n      </video>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default MediaLoader;\r\n","// video-observer.tsx\r\nimport { useEffect } from 'react';\r\n\r\nexport const useVideoVisibility = (\r\n  videoRef: React.RefObject<HTMLVideoElement> | null,\r\n  containerRef: React.RefObject<HTMLElement> | null,\r\n  threshold: number = 0.4\r\n) => {\r\n  useEffect(() => {\r\n    if (!videoRef?.current || !containerRef?.current) return;\r\n\r\n    const t = typeof threshold === 'number' && threshold >= 0 && threshold <= 1 ? threshold : 0.4;\r\n\r\n    let observer: IntersectionObserver | undefined;\r\n\r\n    const video = videoRef.current!;\r\n    const container = containerRef.current!;\r\n\r\n    // IMPORTANT: load even when using <source> children\r\n    // (video.src is empty in that case; currentSrc is set after load())\r\n    video.load();\r\n    video.muted = true;\r\n\r\n    observer = new IntersectionObserver(\r\n      ([entry]) => {\r\n        if (entry.isIntersecting) {\r\n          video.play().catch(() => setTimeout(() => video.play().catch(() => {}), 500));\r\n        } else {\r\n          video.pause();\r\n        }\r\n      },\r\n      { threshold: t }\r\n    );\r\n\r\n    observer.observe(container);\r\n\r\n    // kick once if already in view\r\n    const rect = container.getBoundingClientRect();\r\n    const ratio = Math.min(Math.max((window.innerHeight - rect.top) / window.innerHeight, 0), 1);\r\n    if (ratio >= t) video.play().catch(() => {});\r\n\r\n    return () => observer?.disconnect();\r\n  }, [videoRef, containerRef, threshold]);\r\n};\r\n","import { useEffect, useState } from 'react';\r\nimport { getProjectData } from '../../utils/get-project-data';\r\nimport SplitDragHandler from '../../utils/split+drag/split-controller';\r\nimport PannableViewport from '../../utils/split+drag/pannable-object-position';\r\nimport MediaLoader from '../../utils/media-providers/media-loader';\r\nimport { useTooltipInit } from '../../utils/tooltip/tooltipInit';\r\nimport '../../styles/block-type-1.css';\r\n\r\ntype VideoSet = { webmUrl?: string; mp4Url?: string; poster?: any };\r\ntype MediaSlot = { alt?: string; image?: any; video?: VideoSet };\r\ntype IceData = { mediaOne: MediaSlot; mediaTwo: MediaSlot };\r\n\r\nconst MIN_PORTRAIT_SPLIT = 16;\r\nconst EPS = 0.25;\r\n\r\nexport default function IceCreamScoop() {\r\n  const [data, setData] = useState<IceData | null>(null);\r\n  const [split, setSplit] = useState(() => (window.innerWidth < 1024 ? 45 : 50));\r\n  const [isPortrait, setIsPortrait] = useState(window.innerHeight > window.innerWidth);\r\n\r\n  useTooltipInit();\r\n\r\n  useEffect(() => {\r\n    getProjectData<IceData>('ice-scoop').then((d) => setData(d));\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    const onResize = () => setIsPortrait(window.innerHeight > window.innerWidth);\r\n    window.addEventListener('resize', onResize, { passive: true });\r\n    return () => window.removeEventListener('resize', onResize);\r\n  }, []);\r\n\r\n  if (!data) return null;\r\n\r\n  const media2IsVideo = Boolean(data.mediaTwo?.video?.webmUrl || data.mediaTwo?.video?.mp4Url);\r\n\r\n  const TOP = MIN_PORTRAIT_SPLIT;\r\n  const BOTTOM = 100 - MIN_PORTRAIT_SPLIT;\r\n  const nearTop = isPortrait && split <= TOP + EPS;\r\n  const nearBottom = isPortrait && split >= BOTTOM - EPS;\r\n\r\n  return (\r\n    <section className=\"block-type-1\" id=\"no-ssr\" style={{ position: 'relative' }}>\r\n      {/* LEFT / TOP */}\r\n      <div\r\n        className=\"media-content-1\"\r\n        style={\r\n          isPortrait\r\n            ? nearTop\r\n              ? { height: '0%', width: '100%', position: 'absolute', top: 0, transition: 'height 0.1s ease' }\r\n              : nearBottom\r\n              ? { height: '100%', width: '100%', position: 'absolute', top: 0, transition: 'height 0.1s ease' }\r\n              : { height: `${split}%`, width: '100%', position: 'absolute', top: 0 }\r\n            : { width: `${split}%`, height: '100%', position: 'absolute', left: 0 }\r\n        }\r\n      >\r\n        <PannableViewport sensitivity={2}>\r\n          <MediaLoader\r\n            type=\"image\"\r\n            src={data.mediaOne.image}\r\n            alt={data.mediaOne.alt || 'Ice Cream Scoop media'}\r\n            id=\"icecream-media-1\"\r\n            className=\"media-item-1 tooltip-ice-scoop\"\r\n            objectPosition=\"left center\"\r\n            style={{ width: '100%', height: '100%' }}\r\n          />\r\n        </PannableViewport>\r\n      </div>\r\n\r\n      <SplitDragHandler split={split} setSplit={setSplit} />\r\n\r\n      {/* RIGHT / BOTTOM */}\r\n      <div\r\n        className=\"media-content-2\"\r\n        style={\r\n          isPortrait\r\n            ? nearTop\r\n              ? {\r\n                  height: '100%',\r\n                  width: '100%',\r\n                  position: 'absolute',\r\n                  top: '0%',\r\n                  transition: 'height 0.1s ease, top 0.1s ease',\r\n                }\r\n              : nearBottom\r\n              ? {\r\n                  height: '0%',\r\n                  width: '100%',\r\n                  position: 'absolute',\r\n                  top: '100%',\r\n                  transition: 'height 0.1s ease, top 0.1s ease',\r\n                }\r\n              : {\r\n                  height: `${100 - split}%`,\r\n                  width: '100%',\r\n                  position: 'absolute',\r\n                  top: `${split}%`,\r\n                }\r\n            : {\r\n                width: `${100 - split}%`,\r\n                height: '100%',\r\n                position: 'absolute',\r\n                left: `${split}%`,\r\n              }\r\n        }\r\n      >\r\n        <PannableViewport>\r\n          <MediaLoader\r\n            type={media2IsVideo ? 'video' : 'image'}\r\n            src={media2IsVideo ? (data.mediaTwo.video as VideoSet) : (data.mediaTwo.image as any)}\r\n            alt={data.mediaTwo.alt || 'Ice Cream Scoop media'}\r\n            id=\"icecream-media-2\"\r\n            className=\"media-item-2 tooltip-ice-scoop\"\r\n            objectPosition=\"center bottom\"\r\n            style={{ width: '100%', height: '100%' }}\r\n          />\r\n        </PannableViewport>\r\n      </div>\r\n    </section>\r\n  );\r\n}\r\n"],"names":["totalImages","loadedLowRes","listeners","upgradeTimeout","MediaLoader","type","src","alt","id","className","style","objectPosition","loop","muted","playsInline","preload","enableVisibilityControl","priority","controls","isSSR","window","loaded","setLoaded","useState","showMedium","setShowMedium","showHigh","setShowHigh","posterRemoved","setPosterRemoved","videoRef","useRef","imgRef","containerRef","isNear","ref","rootMargin","threshold","once","near","setNear","useEffect","current","io","IntersectionObserver","entries","some","e","isIntersecting","disconnect","observe","useNearViewport","shouldStart","complete","readyState","setUpgradeTimeout","ms","setTimeout","forEach","fn","t1","callback","off","push","t2","clearTimeout","onMediaLoaded","event","CustomEvent","detail","dispatchEvent","isVideoSetObj","vs","undefined","legacyVideoUrl","posterUrl","poster","urlFor","width","quality","auto","url","v","hidePoster","removeAttribute","onPlay","anyV","requestVideoFrameCallback","onTime","currentTime","removeEventListener","addEventListener","timer","useVideoVisibility","t","observer","video","container","load","entry","play","catch","pause","rect","getBoundingClientRect","Math","min","max","innerHeight","top","retryTimer","promoteTimer","kickLoad","tryPlay","async","paused","onLoadedMeta","nudgeDecode","onLoadedData","onCanPlay","onError","console","warn","onStalled","onSuspend","webmUrl","mp4Url","hasVideoSource","Boolean","ultraLowSrc","getLowResImageUrl","mediumSrc","getMediumImageUrl","highResSrc","getHighQualityImageUrl","resolvedSrc","_jsxs","position","height","children","_jsx","LoadingScreen","isFullScreen","loading","fetchPriority","onLoad","target","draggable","objectFit","opacity","transition","showSpinner","onLoadedMetadata","pointerEvents","zIndex","MIN_PORTRAIT_SPLIT","EPS","IceCreamScoop","data","setData","split","setSplit","innerWidth","isPortrait","setIsPortrait","useTooltipInit","getProjectData","then","d","onResize","passive","media2IsVideo","mediaTwo","nearTop","nearBottom","left","PannableViewport","sensitivity","mediaOne","image","SplitDragHandler"],"sourceRoot":""}